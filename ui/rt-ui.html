<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Faust RT UI</title>
  <link rel="stylesheet" href="/faust-ui/index.css" />
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    .page {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
      padding: 20px 24px;
    }
    h1 { margin-bottom: 8px; text-align: center; }
    .status { color: #444; margin-bottom: 16px; display: none; text-align: center; }
    .param { margin: 10px 0; }
    .param label { display: block; font-size: 13px; color: #333; }
    .param input[type=range] { width: 320px; }
    .param .value { display: inline-block; min-width: 60px; text-align: right; }
    #fallback-ui { text-align: center; }
    #fallback-ui .param { display: inline-block; text-align: left; margin: 10px 12px; }
    #faust-ui-container {
      margin-top: 16px;
      flex: 1 1 auto;
      min-height: 0;
      position: relative;
      display: flex;
      border-radius: 6px;
    }
    #faust-ui-root {
      position: absolute;
      inset: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }
    #dsp-name { font-weight: 600; margin-top: 4px; text-align: center; }
  </style>
</head>
<body>
  <div class="page">
    <h1>Faust Real-time UI</h1>
    <div class="status" id="status">Loading...</div>
    <div id="dsp-name"></div>
    <div id="faust-ui-container">
      <div id="faust-ui-root"></div>
    </div>
    <div id="fallback-ui"></div>
  </div>

  <script type="module">
    async function fetchJson(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`HTTP ${res.status} ${path}`);
      return res.json();
    }

    async function setParam(path, value) {
      await fetch('/param', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path, value })
      });
    }

    const fallbackControls = new Map();
    let faustUiInstance = null;

    function renderFallback(params) {
      const container = document.getElementById('fallback-ui');
      container.innerHTML = '';
      fallbackControls.clear();
      params.forEach((param) => {
        const wrap = document.createElement('div');
        wrap.className = 'param';
        const label = document.createElement('label');
        label.textContent = `${param.path} (${param.label || ''})`;
        const input = document.createElement('input');
        input.type = 'range';
        input.min = param.min ?? 0;
        input.max = param.max ?? 1;
        input.step = param.step ?? 0.01;
        input.value = param.init ?? param.min ?? 0;
        const value = document.createElement('span');
        value.className = 'value';
        value.textContent = input.value;
        input.addEventListener('input', async () => {
          value.textContent = input.value;
          await setParam(param.path, Number(input.value));
        });
        wrap.append(label, input, value);
        container.append(wrap);
        fallbackControls.set(param.path, { input, value });
      });
    }

    async function fetchParamValues() {
      const res = await fetch('/param-values');
      if (!res.ok) return null;
      return res.json();
    }

    function applyParamValues(values) {
      if (!values || !Array.isArray(values)) return;
      values.forEach((entry) => {
        if (!entry) return;
        const path = entry.path;
        const value = entry.value;
        if (faustUiInstance) {
          faustUiInstance.paramChangeByDSP(path, value);
        }
        const fallback = fallbackControls.get(path);
        if (fallback) {
          fallback.input.value = value;
          fallback.value.textContent = value;
        }
      });
    }

    async function tryFaustUI(faustJson, params) {
      // Optional: load faust-ui bundle if provided under /faust-ui/.
      try {
        const module = await import('/faust-ui/index.js');
        console.log('faust-ui module keys:', Object.keys(module));
        const FaustUI = module.default || module.FaustUI || null;
        if (!FaustUI) return false;
        const root = document.getElementById('faust-ui-root');
        root.innerHTML = '';
        const ui = new FaustUI({
          root,
          ui: faustJson.ui || [],
          listenWindowMessage: false,
          listenWindowResize: true,
        });
        ui.paramChangeByUI = async (path, value) => {
          await setParam(path, value);
        };
        if (ui && typeof ui.mount === 'function') {
          ui.mount();
        }
        root.style.minWidth = `${ui.minWidth}px`;
        root.style.minHeight = `${ui.minHeight}px`;
        if (typeof ui.resize === 'function') {
          ui.resize();
        }
        faustUiInstance = ui;
        return true;
      } catch (err) {
        console.error('Failed to load faust-ui module', err);
        const status = document.getElementById('status');
        status.textContent = `faust-ui load failed: ${err}`;
        faustUiInstance = null;
        return false;
      }
    }

    async function renderOnce() {
      const status = document.getElementById('status');
      const dspName = document.getElementById('dsp-name');
      try {
        const statusJson = await fetchJson('/status');
        dspName.textContent = statusJson.name ? `DSP: ${statusJson.name}` : 'DSP: (none)';
        const json = await fetchJson('/json');
        const params = await fetchJson('/params');
        const usedFaustUI = await tryFaustUI(json, params.params || params);
        if (!usedFaustUI) {
          renderFallback(params.params || params);
        }
        const values = await fetchParamValues();
        applyParamValues(values?.values);
        return JSON.stringify({ name: statusJson.name, json });
      } catch (err) {
        status.textContent = String(err);
        return null;
      }
    }

    async function main() {
      let lastJson = await renderOnce();
      setInterval(async () => {
        try {
          const json = await fetchJson('/json');
          const statusJson = await fetchJson('/status');
          const current = JSON.stringify({ name: statusJson.name, json });
          if (current && current !== lastJson) {
            const params = await fetchJson('/params');
            const dspName = document.getElementById('dsp-name');
            dspName.textContent = statusJson.name ? `DSP: ${statusJson.name}` : 'DSP: (none)';
            const usedFaustUI = await tryFaustUI(json, params.params || params);
            if (!usedFaustUI) {
              renderFallback(params.params || params);
            }
            lastJson = current;
          }
        } catch (err) {
          const status = document.getElementById('status');
          status.textContent = String(err);
        }
        const values = await fetchParamValues();
        applyParamValues(values?.values);
      }, 1500);
    }

    main();
  </script>
</body>
</html>
